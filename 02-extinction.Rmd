---
output: 
  rmarkdown::html_document:
    css: custom.css
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
editor_options: 
  chunk_output_type: console
---

```{r test_setup, echo = FALSE, message=FALSE}
options(knitr.table.format = "html")
library(plyr)

library(dplyr)
library(ecosscraper)
library(fuzzyjoin)
library(ggplot2)
library(kableExtra)
library(knitr)
library(leaflet)
library(parallel)
library(rredlist)
library(rio)
library(rmapshaper)
library(RPostgreSQL)
library(stringr)
library(tokenizers)
library(us.geonames)

# read in some data
cnt_occ <- readRDS("data/ESA_county_occurrences.rds")
fiveyr_table <- readRDS("data/fiveyr_table_2016-12-17.rds")

# TECP_table <- get_TECP_table()
# tne <- TECP_table %>% filter_listed() %>% filter(U_S__or_ForeignListed != "Foreign")

con <- dbConnect(
  dbDriver("PostgreSQL"),
  dbname = "esc-dev",
  user = "postgres",
  password = "SillySilly1!",
  host = "localhost"
)

tne <- dbSendQuery(con, "select * from tecp_table") %>%
  dbFetch() %>%
  filter_listed() %>%
  filter_domestic()

get_text <- function(file) {
    text <- readLines(con = file) %>%
      paste(collapse = " ") %>%
      str_replace_all("[ ]{2,}", " ")
    return(text)
}

simple_tab <- function(v, vname = "var", useNA = "always", n = 10) {
  table(v, useNA = useNA) %>% 
    sort(decreasing = TRUE) %>%
    as_data_frame() %>%
    plyr::rename(replace = c("v" = vname)) %>% 
    head(n) %>%
    kable() %>%
    kable_styling(bootstrap_options = "hover")
}
```

# Extinction and the ESA {#extinct}

<div class="abstract">
**_Abstract_**

The success of the Endangered Species Act (ESA) is often measured by comparing the number of species declared extinct to the number of listed species, which indicates success on the order of 99%. Here we check that measure against the discussions of extinction by the Fish and Wildlife Service and the National Marine Fisheries Service by mining five-year status reviews and other relevant data. The review suggests 90 (~5%) domestic ESA-listed species are known or are likely to be extinct, plus at least six and likely more that are extinct in the wild. We are unable to provide a rigorous analysis of causes of extinction, but identify three broad categories of common causes: invasive species, natural accidents, and overexploitation / habitat destruction. We discuss how these results inform discussions of the successes of the ESA and the law's limitations, and close with a hopeful but cautionary tale about extinction. 
</div>

The extinction crisis of the modern era was a key motivation for the ESA: the goals of the law include preventing extinction and recovering species so they are no longer threatened with extinction. One of the ways ESA success has been measured is by comparing the number of listed species to the number that have been declared extinct and delisted. As of this writing, ten species have been removed from the list of threatened and endangered species because of extinction, and the list includes 1,660 species for approximately `r 100 - (100 * round(10 / 1660, 2))`% success.

But there are at least two problems with using the number of species "delisted due to extinction" as the metric of success. First, it dismisses the key goal of species recovery and instead sets a lower bar of mere existence as success. But we don't want to argue that plants and animals known only to exist in captivity, or in such low numbers that their [ecological role](https://smile.amazon.com/Ecological-Niches-Contemporary-Interspecific-Interactions/dp/0226101800/ref=sr_1_1) is lost, count as successes. Success is wildlife out on the landscape as part of the ecological community.

Second, we know that the ten delisted species are just the ones that have been formally declared extinct. But proving extinction is tough: it's easy to confirm something is present, but confirming absence (of typically hard-to-find species) is fraught with problems. Did we look at the right place, at the right time, and under the right conditions and just miss it? Or is the species truly gone? The caution of declaring extinction is well-deserved: we have too many examples where a [species hadn't been seen for decades or even over three centuries](http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0022531), only to be rediscovered. And getting either extinction or rediscovery wrong can have [negative consequences for conservation](https://www.researchgate.net/publication/26879484_Caution_with_claims_that_a_species_has_been_rediscovered). For such reasons, declarations of extinction are a rare occurrence. At the same time, we often have a very good idea that well-documented species are extinct, but hold off on the declarations of extinction and the removal of protections because of the small chance that one or a few individuals still exist. 

We have two goals in this analysis. First is to identify ESA-listed species that experts--primarily biologists with the U.S. Fish and Wildlife Service (FWS) and National Marine Fisheries Service (NMFS; collectively, the Services)--have good reason to believe are extinct. We use a [combination of computational and manual curation](#methods) and data from other highly regarded sources, including IUCN and the [Plant Extinction Prevention Program](http://pepphi.org) to create this list. _Declaring_ extinction may not be warranted for most of these species, but the professionals have indicated that extinction is likely to some greater or lesser degree. Second, we summarize the likely causes of these species' extinction. This is not a rigorous analysis because of various uncertainties, but it provides an important (and somewhat surprising) backdrop for interpreting the extinction data. We discuss the implications of our results with respect to how conservationists discuss the effectiveness of the ESA.

## Possible/probable extinctions

```{r terms_1, echo = FALSE}
src <- "~/Downloads/five_year_review"
fils <- list.files(src, full.names = TRUE, recursive = TRUE)

terms <- c(
  "(possibly|may be|have become) extinct",
  "(certainly being|probably|is|likely|probably being) extinct",
  "no (populations|individuals)( are)* known",
  "no( known| living)* individuals",
  "extinct in( the)* wild",
  "last (seen|observed|found) in [0-9oOiI]+",
  "functionally extinct"
)

proc_file <- function(f) {
  cat(paste("\nProcessing:", basename(f), "\n"))
  text <- get_text(f) %>%
    tokenize_sentences(lowercase = TRUE, simplify = TRUE)
  res <- data_frame(file = NA, patt = NA, doc = NA, mats = NA)
  for(i in 1:length(terms)) {
    mat <- grep(text, pattern = terms[i], fixed = FALSE, value = TRUE)
    nhit <- length(mat)
    if(nhit > 0) {
      resi <- data_frame(file = rep(f, nhit), 
                         doc = rep(basename(f), nhit),
                         patt = rep(i, nhit), 
                         mats = mat)
    } else {
      resi <- data_frame(file = f, patt = i, doc = basename(f), mats = NA)
    }
    res <- rbind(res, resi)
  }
  return(res)
}

# t1 <- parallel::mclapply(fils, 
#                          proc_file, 
#                          mc.cores = 3, 
#                          mc.preschedule = FALSE)
# ext_pat <- bind_rows(t1) %>% filter(!is.na(mats))
# fname <- paste0("data/extinct_patt_matches-", Sys.Date(), ".rds")
# saveRDS(ext_pat, fname)
fname <- paste0("data/extinct_patt_matches-2017-09-12.rds")
ext_pat <- readRDS(fname)
```

```{r load_manual, echo = FALSE}
# fiveyr_table <- readRDS("data/fiveyr_table_2016-12-17.rds")
# w_spp <- left_join(ext_pat, fiveyr_table, by = "doc")
# rio::export(w_spp, "data/ext_patt_w_spp.xlsx")
#
###### MANUAL FILTER #######
#
ext_5yr <- readRDS("data/extinct_manual_check_2017-09-05.rds")

extinct <- filter(ext_5yr, true_positive == "T") %>%
             filter(is.na(comment) | 
                      comment == "HI birds" |
                      comment == "uncertain status") %>%
             filter(Species != "Phyllostegia mollis") %>%
             filter(Species != "Melicope quadrangularis")
spp_ls <- unique(extinct$Species[!is.na(extinct$Species)])
spp_ls <- c(spp_ls, "Campephilus principalis", "Vermivora bachmanii")

ext_wild <- filter(ext_5yr, comment == "extinct in wild") %>%
  distinct(Species)
```

Using [full-text searches plus manual filtering](#methods), we first identified `r length(spp_ls) - 1` species that are believed extinct to some greater or lesser degree, plus the [snail genus _Achatinella_](#achatinella).

<div class="cols-2">
```{r echo=FALSE}
spp <- sort(spp_ls)
half <- ceiling(length(spp) / 2)
first <- spp[1:half]
secnd <- spp[(half+1):length(spp)]
kable(first)
kable(secnd)
```
</div>

The list includes some well-known species, like the [eastern cougar](https://www.fws.gov/northeast/ECougar/) and the [Eskimo Curlew](https://neotropical.birds.cornell.edu/Species-Account/nb/species/eskcur/overview). But other species are much less well-known, like _Cyanea supurba_, a Hawaiian plant that was last seen in XXXXX. 

### _Achatinella_ snails {#achatinella}

```{r echo=FALSE}
# acha <- readxl::read_excel("data-raw/Achatinella.xlsx")
# saveRDS(acha, file = "data/Achatinella.rds")
acha <- readRDS("data/Achatinella.rds")
acha$species <- paste("Achatinella", acha$species)
ext_ach <- filter(acha, believed_extinct == "T")
```

Some `r length(unique(acha$species))` species or subspecies of _Achatinella_ snails have been described, all native to the tropical forests of Oahu. Unfortunately, they have suffered more likely extinctions than any other genus of ESA-listed species. Based on the status discussed in the last five-year reviews for the genus (2011) plus information gleaned from other sources (e.g., IUCN and NatureServe), `r length(ext_ach$species)` _Achatinella_ are likely extinct:

<div class="narrow-tab">
```{r echo=F}
select(ext_ach, c(1,2,9)) %>%
  kable(align = c("l", "c", "c")) %>%
  kable_styling(bootstrap_options = "hover")
```
</div>

### PEPP

The [Plant Extinction Prevention (PEP) Program](http://www.pepphi.org/) works exhaustively to monitor and conserve Hawaiian plants. They also provide more up-to-date data on the status of many imperiled plants than FWS documents, and should be considered authoritative for PEP species. We downloaded the 2017-03-16 list from PEP's website then used Adobe's online extraction service to render the tables as a spreadsheet for processing. To begin, we have a high-level overview of how PEP classifies the covered species:

<div class="narrow-tab">
```{r echo=FALSE}
PEP <- readRDS("data/HI_PEP_2017-03-16.rds")
extrp_wild <- filter(PEP, island_designation == "PEP-EXTIRPATED" |
                       island_designation == "PEP-EXTIRPATED?")
table(PEP$island_designation) %>%
  as_data_frame() %>%
  rename(PEP_class = Var1) %>%
  kable() %>%
  kable_styling(bootstrap_options = "hover")
```
</div> 

The numbers from PEP indicate the scale of the challenge Hawaiian plants face. Note the refinement of extinct in the wild vs. extinct from the planet, which we will return to later. But first, what are the PEP species that are thought extinct? ("NL" = not listed)

<div class="narrow-tab">
```{r pep_ext_table, echo = FALSE, message = FALSE}
pep_extinct <- filter(PEP, island_designation == "PEP-EXTINCT?")
list_stat <- c("NL", rep("E", 5), "NL", rep("E", 3), "NL", "E", rep("NL", 5),
               "E", NA, "E")
pep_extinct$status <- list_stat
pep_extinct$distribution <- str_replace_all(
  pep_extinct$distribution,
  "`", "'"
)
kable(pep_extinct) %>%
  kable_styling(bootstrap_options = "hover")
```
</div>

The PEP tabulation places 20 Hawaiian plants they have worked with in the extinct (?\*) category. Of these, eleven are listed (endangered), and their listing rules or (just released) five-year reviews suggest extinction. 

\* _Appropriately, PEP uses "?" to denote species for which extirpation and extinction are uncertain._

### Declared extinct

In addition to the species identified above, we know that some species have been delisted because they have been formally designated as extinct.

<div class="narrow-tab">
```{r delist_ext, echo = FALSE, message = FALSE}
delisted <- readr::read_tsv("data/delisted_species_2018-01-03.tsv")
names(delisted) <- c("date_delisted", "species", "date_listed", "reason_delisted",
                   "dom_for", "service")
dl_ext <- filter(delisted, reason_delisted == "Extinct")
dl_ext$species <- str_replace_all(dl_ext$species, "[ ]+- Wherever found", "")
select(dl_ext, c(2,3,1)) %>%
  kable() %>%
  kable_styling(bootstrap_options = "hover")
```
</div>

```{r n_extinct_calcs, echo = FALSE}
pep_ext_list <- filter(pep_extinct, status == "E")
n_ext <- length(spp) + length(dl_ext$species) + length(ext_ach$species) +
         length(pep_ext_list$species)
```

<div class="main-result">
Available data indicate **`r n_ext` (`r 100*round(n_ext/dim(tne)[1], 3)`%) current or formerly ESA-listed species are thought to be extinct.**
</div>

### Extinct in the wild

Note that these numbers do not include species that are extinct in the wild, but often number just a few in propagation or captivity. We identified `r length(ext_wild[[1]])` such species in our scans - _`r paste(ext_wild[[1]], collapse=", ")`_ - but the number is likely higher. For example, the PEPP data indicated 14 Hawaiian plants that are extinct in the wild.

Most of the extinct species are from Hawaii, with many that are plants [Box 1](#box_1) or snails. In the subsequent analyses we collapse all 31 extinct species in the genus _Achatinella_ to "_Achatinella_ spp." because they were all from the same place and faced the same threats; this should help reduce bias in our inferences.

## Patterns of extinction

### Causes of extinction

The causes of extinction are often complex, with no single mechanism responsible for the loss of a species. The Passenger Pigeon is a well-known example of this complexity. Rather than being lost solely to hunting, or solely to habitat loss, the species was likely lost through a combination of those factors plus an interaction with the species' social behavior. We can't determine the causes of extinction of all `r n_ext` species identified above, but we have noticed three basic categories of causes:

1. _Invasive species:_ Easily the most common factor for extinction by number of species--driven by the _Achatinella_ snails and Hawaiian plants--is invasive species\*. The culprits include feral hogs, predatory snails, avian malaria, and a multitude of plants. Regardless the mechanism by which the invasives affected the listed species--trampling, predation, disease, competition--the end result was the same: species driven to extinction, or so compromised that they became susceptible to factors such as natural "accidents."

2. _Natural "accidents":_ A surprisingly common theme in the narratives of species' demise is the role of natural accidents. _Hibiscadelphus woodii_ was only ever known from four plants, three of which were taken out by a rockslide and the fourth died some years later. (Efforts were made to propagate the species, but were unsuccessful.) Several plants are believed to have been lost to Hurricane Iniki in 1992. 

3. _"Unnatural" processes:_ Some of the commonly recognized species on the list--like the eastern cougar and the Eskimo Curlew-- almost certainly fell victim to overharvest. Others, like the Maryland darter and Bachman's Warbler, most likely fell victim to anthropogenic habitat destruction and degradation. Similarly, several mussels in the Southeast we likely driven to extinction by a combination of abiotic habitat modification such as silt and pollution and (perhaps) biotic changes such as loss of fish hosts. Even though these "unnatural" processes were likely responsible for some extinctions, what stands out from the data extraction and analysis is how they are relatively uncommon.

\* Most invasives arrive by human transport, but we separate this cause from the "unnatural processes" of point 3 because the threat was not active act like those.

## Conclusion

The community that works on and defends the ESA should not continue using the "99% effective" phrase to discuss the law's success. Our analysis indicates that the number is likely closer to 95%, but even that misses the point of recovering--truly conserving--species. Re-phrasing it as "only 1% of listed species have been declared extinct" is technically true, but is deliberately misleading. One can even argue that it is "disrespectful" to those species that have likely gone extinct to not recognize the loss. Importantly, there are strategic problems with using the 99% figure: why are more resources needed if the ESA is so effective? Like many others, we have heard this argument against additional ESA support again-and-again. Highlighting real successes where they exist is part of the ESA defensive strategy, but there also needs to be a more realistic treatment of extinction and decline.

In addition to getting a better estimate of the number of likely extinctions, this analysis points to the importance of recalibrating expectations about what the ESA (or any law) can achieve. Far too often, the message is that ESA listing in and of itself secures species. But the ESA could not have done much for most of the ~90 likely extinct species we identified: invasive species*, hurricanes, and rock slides don't care about the law, even though they are common (likely) causes of extinction of ESA-listed species. The distinction between this class of threat and those like ongoing overharvest and habitat destruction is an important nuance. By not addressing these nuances directly, expectations for the ESA have been set too high in the public consciousness. On one hand, most people don't care about details like this; if they have any interest, they just want to know species are protected. On the other hand, ESA opponents perpetuate and exacerbate the problem by contributing to completely unrealistic expectations for the law (like saying the ESA is a failure because so few species have been recovered). Fortunately, we can address this by 

* The invasive species issue isn't that humans aren't involved--we are--it's that the scale of the problem is so large as to mostly be unmanageable. 

### Coda

Conducting this analysis hasn't been the most uplifting exercise: not much good news in here. But as we cautioned from the beginning, declaring extinction is fundamentally hard and is a step only taken with great care. There is no better example to illustrate why we must take care--and why we do not think the 80 species identified here should be declared extinct until species experts deem it appropriate--than _Melicope quadrangularis_. This Hawaiian tree was discovered in 1909, then "lost" until 1991, when a population was found again. Then Hurricane Iniki struck in 1992 and for 20 years it was thought that species had been wiped out because that single population had been destroyed. When we first did this analysis in mid-2017, the most recent 5-year review (2010) indicated this history and we identified it as a likely extinct species in our list. But the [2017 5-year review](https://ecos.fws.gov/docs/five_year_review/doc5340.pdf), which we reviewed as part of finalizing this analysis, presented hopeful new information: a stand of four _M. quadrangularis_ was found in another location in 2013, followed by other populations in subsequent years. Efforts to find and propagate the species are continuing by PEP, which is great news. 


## Methods {#methods}

We used a two-step process to identify the likely extinct species. First, we used a coarse filter to search across all ~1,400 five-year reviews with seven [regular expression](https://www.rstudio.com/wp-content/uploads/2016/09/RegExCheatsheet.pdf) patterns:

<div style="font-size:smaller">
1. `"(possibly|may be|have become) extinct"`
2. `"(certainly being|probably|is|likely|probably being) extinct"`
3. `"no (populations|individuals)( are)* known"`
4. `"no( known| living)* individuals"`
5. `"extinct in( the)* wild"`
6. `"last (seen|observed|found) in [0-9oOiI]+"`
7. `"functionally extinct"`
</div>
    
In these patterns, "|" means "or" for the set of words inside parentheses. For example, the first pattern would match "possibly extinct," "may be extinct," or "have become extinct." The "\*" means the preceding letter or word matches zero or more times, whereas "+" means the preceding word/letter(s) must match one or more times. We checked all seven patterns against all 1,385 five-year reviews we collected from [ECOS](https://ecos.fws.gov) and [NMFS's recovery site](http://www.nmfs.noaa.gov/pr/recovery/plans.htm).

A basic search returned `r dim(ext_pat)[1]` matches to [the set of candidate phrase patterns](#phrase_patterns), including patterns that indicate a higher likelihood of extinction such as: 

<div class="narrow-tab">
```{r patt_2, echo = FALSE} 
t4 <- filter(ext_pat, patt == 2) %>% 
  select(mats) %>% 
  data.frame() %>%
  head()
kable(paste("-", t4$mats))
```
</div>

Perusing these example pattern matches, we find - as expected - both true positives (i.e., the meaning of the matched sentence comports with the idea we have in mind) and false positives (e.g., local extinctions or species previously believed extinct but since re-discovered). 

Next, we manually checked each 5-year review with an extinction phrase match to remove the false-positives. The _Achatinella_ snails are taxonomically complex and all of their five-year reviews have been combined in a [single document](https://ecos.fws.gov/docs/five_year_review/doc3903.pdf), so we compiled their results manually for all species. In addition, we checked the NatureServe Explorer and IUCN Red List web sites for any additional information for the snails. 

We downloaded the list of delisted species from FWS's [ECOS website](https://ecos.fws.gov/ecp0/reports/delisting-report) in January, 2018, and included only those species for which the "Reason Delisted" was Extinct.


## Appendices

<!-- <div id="box_1", class="aside-box"> -->
### Appendix A. Additional PEP data

In addition to the extinctions, the PEP data highlight the problem of extirpations: `r length(unique(extrp_wild$species))` PEP species have been (or probably have been) extirpated from one or more of the islands. First, the number of species extirpated, by island:

<div class="narrow-tab">
```{r echo=FALSE}
spXis_tab <- table(extrp_wild$species, extrp_wild$distribution)
colnames(spXis_tab) <- str_replace_all(colnames(spXis_tab), "`", "")
colSums(spXis_tab) %>% 
  sort(decreasing = TRUE) %>% 
  head(10) %>% 
  as_data_frame() %>%
  rename(extirpations = value) %>%
  kable() %>%
  kable_styling(bootstrap_options = "hover")
```
</div>

Alternatively, the species with the most extirpations from Hawaiian islands.

<div class="narrow-tab">
```{r echo = FALSE}
rowSums(spXis_tab) %>%
  sort(decreasing = TRUE) %>% 
  head(10) %>%
  as_data_frame() %>%
  rename(extirpations = value) %>%
  kable() %>%
  kable_styling(bootstrap_options = "hover")
```
</div>

```{r echo=FALSE}
hi_cnt <- filter(cnt_occ, STATE == "Hawaii")
pep_miss <- setdiff(unique(hi_cnt$SCI), PEP$species)
```

The PEP data adds depth to our understanding of extinctions and extirpations among Hawaiian plants, but PEP does not cover `r length(pep_miss)` ESA-listed plants. For these species in particular it is important for FWS to track species status. One way that is done is with ESA-mandated five-year reviews of species status. Here is the distribution of years in which five-year reviews were done for the `r length(pep_miss)` PEP-missing species:

```{r echo=FALSE, message=FALSE, warning=FALSE}
pep_miss_5y <- filter(fiveyr_table, fiveyr_table$Species %in% pep_miss)
pep_miss_5y$age <- as.numeric(Sys.Date() - as.Date(pep_miss_5y$Date))
date_tab <- as.Date(pep_miss_5y$Date) %>%
  lubridate::year() %>%
  table() %>%
  as_data_frame() %>%
  rename(year = '.')
p <- ggplot(date_tab, aes(x = year, y = n)) +
  geom_histogram(stat = "identity") +
  labs(x = "", y = "count") +
  ggthemes::theme_hc()
plotly::ggplotly(p)
```

There are `r length(pep_miss_5y$age)` non-PEP species with 5-year reviews available, and of those reviews, `r sum(pep_miss_5y$age > (365*5))` are out-of-date (i.e., more than five years old). 
<!-- </div> -->

### Appendix B. Geography of extinction

Where have extinctions occurred? Hawaii, of course, tops the list, but where are the other species? Below we focus on the 36 species found across our document scans because of the Hawaiian tilt of the other lists.

```{r state_level, echo = FALSE, fig.cap="States with the most (likely) extinctions."}
w_co <- left_join(extinct, cnt_occ, by = c("Species" = "SCI"))
spp_w_st <- distinct(w_co, Species, STATE)
dist <- filter(ext_5yr, true_positive == "T") %>% 
  distinct(Species, .keep_all = TRUE) %>%
  filter(!is.na(Date))

ext_geo <- left_join(dist, cnt_occ, by = c("Species" = "SCI"))
ext_geo_state <- distinct(ext_geo, Species, STATE, .keep_all = TRUE)
ext_state_cnt <- table(ext_geo_state$STATE) %>% 
  sort(decreasing = TRUE) %>%
  as_data_frame()

states <- readRDS(file = "data/state-simple.geo.json")
names(ext_state_cnt) <- c("NAME10", "n_extinct")
state_ext_geo <- sp::merge(states, ext_state_cnt)

n_ex_bins <- c(0, 1, 2, 3, 5, 24)
n_ex_pal <- colorBin(
  "YlOrRd", 
  domain = state_ext_geo$n_extinct, 
  bins = n_ex_bins
)

labels <- sprintf(
  "<strong>%s</strong><br/>%g extinct species",
  state_ext_geo$NAME10, state_ext_geo$n_extinct
) %>% lapply(htmltools::HTML)

leaflet(state_ext_geo) %>%
  setView(-110, 45, 3) %>%
  addProviderTiles("Stamen.TonerLite") %>%
  addPolygons(
    fillColor = ~n_ex_pal(n_extinct),
    weight = 1,
    opacity = 1,
    color = "white",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 2,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto")
  ) %>% 
  addLegend(
    pal = n_ex_pal,
    values = ~n_extinct,
    opacity = 0.7, 
    title = NULL,
    position = "bottomright"
  )
```

<div class="narrow-tab">
```{r echo=FALSE}
names(ext_state_cnt) <- c("state", "n_extinct")
table(ext_geo_state$STATE) %>%
  sort(decreasing = TRUE) %>%
  as_data_frame() %>%
  rename("state" = "Var1") %>%
  head() %>%
  kable() %>%
  kable_styling(bootstrap_options = "hover")
```
</div>

Again, Hawaii clearly shows up with the most species, but the swath from Mississippi to Virginia stands out too. Most of these species are mussels and fish, so the issue may be related to the problems apparent in this (albeit old) [Clean Water Act 303(d) impaired waters](https://www.epa.gov/tmdl).

In addition to the state-level patterns of extinction, we can use counties of occurrence to evaluate patterns of the geography of extinction. The ten counties with the most extinct species include:

<div class="narrow-tab">
```{r county_level, echo = FALSE, fig.cap="Ten counties with the greatest number of likely extinct, ESA-listed species. Excludes 'NA' entries for species lacking county data."}
ext_geo$co_st <- paste0(ext_geo$NAME, ", ", ext_geo$STATE)
ext_geo_st_co <- distinct(ext_geo, Species, co_st, .keep_all = TRUE)
table(ext_geo_st_co$co_st) %>%
  sort(decreasing = TRUE) %>%
  as_data_frame() %>%
  filter(Var1 != "NA, NA") %>%
  rename(`State, County` = Var1) %>%
  head(10) %>%
  kable() %>%
  kable_styling(bootstrap_options = "hover")
```
</div>

As expected, Hawaiian counties top the list, followed by Guam, then southern Appalachian counties in Tennessee, Virginia, and Kentucky. Thus, although Alabama and Mississippi have more extinct, listed species than these states, those species are (were) more concentrated in Tennessee, Virginia, and Kentucky.

### Appendix C. Common threats and habitats

In the main text we gave a cursory overview of our observations on the causes of extinction because they provide important context in thinking about the ESA and extinction. At the same time, we caution that those are observations rather than rigorous analyses. However, we also analyzed [IUCN data](http://apiv3.iucnredlist.org/) on species' habitats and threats. That is, given the list of likely extinct species, we would like to know what they have in common that might inform prioritization efforts that can stem future extinctions. We include the analyses below, but note that the data are incomplete enough that this should be considered preliminary rather than conclusive.

We used data available through the [IUCN's Red List database]() for habitats and threats.

**Habitats**

```{r echo=FALSE}
# ext_iucn_habitat <- lapply(
#   unique(ext_geo$Species), 
#   rl_habitats, 
#   key = "b14503ec6ef80c6c07ca33baf728efdbc2f10fc6373d779f0d7efb8b98049ee7"
# )
# for(i in 1:length(ext_iucn_habitat)) {
#   ext_iucn_habitat[[i]]$result$species <- ext_iucn_habitat[[i]]$name
# }
# ext_iucn_habitat_dfs <- lapply(ext_iucn_habitat, `[[`, 2)
# ext_iucn_habitat_df <- bind_rows(ext_iucn_habitat_dfs)
# saveRDS(ext_iucn_habitat_df, file = "data/extinct_iucn_habitat.rds")
ext_iucn_habitat_df <- readRDS("data/extinct_iucn_habitat.rds")
table(ext_iucn_habitat_df$habitat, useNA = "always") %>% 
  sort(decreasing = TRUE) %>%
  as_data_frame() %>%
  rename(habitat = Var1) %>%
  head(10) %>%
  kable() %>%
  kable_styling(bootstrap_options = "hover")
```

The most common defined habitats for the extinct species parallels those species' geography: subtropical / tropical forests of Hawaii where species such as the _Achatinella_ snails, various plants, and birds lived. Inland wetlands, in particular the rivers, streams, and creeks inhabited by likely extinct mussels and fishes, are the second major group. Last, notice the most common habitat type is actually "NA." This points to a limitation of the IUCN's database, incomplete information.

**Threats**

```{r echo=FALSE}
# ext_iucn_threats <- lapply(
#   unique(ext_geo$Species), 
#   rl_threats, 
#   key = "b14503ec6ef80c6c07ca33baf728efdbc2f10fc6373d779f0d7efb8b98049ee7"
# )
# for(i in 1:length(ext_iucn_threats)) {
#   ext_iucn_threats[[i]]$result$species <- ext_iucn_threats[[i]]$name
# }
# ext_iucn_threats_dfs <- lapply(ext_iucn_threats, `[[`, 2)
# ext_iucn_threats_df <- bind_rows(ext_iucn_threats_dfs)
# table(ext_iucn_threats_df$title) %>% sort(decreasing = TRUE)
# no_iucn_threat <- filter(ext_iucn_threats_df, is.na(title))
# no_thr_syn <- lapply(
#   unique(no_iucn_threat$species),
#   rl_synonyms, 
#   key = "b14503ec6ef80c6c07ca33baf728efdbc2f10fc6373d779f0d7efb8b98049ee7"
# )
# no_thr_syn_res <- lapply(no_thr_syn, `[[`, 3) %>% bind_rows()
# 
# ext_iucn_thr2 <- lapply(
#   unique(no_thr_syn_res$accepted_name), 
#   rl_threats, 
#   key = "b14503ec6ef80c6c07ca33baf728efdbc2f10fc6373d779f0d7efb8b98049ee7"
# )
# for(i in 1:length(ext_iucn_thr2)) {
#   ext_iucn_thr2[[i]]$result$species <- ext_iucn_thr2[[i]]$name
# }
# ext_iucn_thr2_dfs <- lapply(ext_iucn_thr2, `[[`, 2)
# ext_iucn_thr2_df <- bind_rows(ext_iucn_thr2_dfs)
# 
# extinct_spp_iucn_threats <- ext_iucn_threats_df %>%
#   select(8, 1:7) %>%
#   rbind(ext_iucn_thr2_df) %>% 
#   filter(!(species %in% no_thr_syn_res$synonym))
# saveRDS(extinct_spp_iucn_threats, file = "data/extinct_iucn_threats.rds")
extinct_spp_iucn_threats <- readRDS("data/extinct_iucn_threats.rds")

simple_tab(extinct_spp_iucn_threats$title, vname = "title")
```

```{r echo=FALSE}
simple_tab(extinct_spp_iucn_threats$code, vname = "code")
extinct_spp_iucn_threats$simple_code <- extinct_spp_iucn_threats$code %>%
  str_split(pattern = "\\.") %>%
  lapply(FUN = `[[`, 1) %>%
  unlist()
cur_dat <- extinct_spp_iucn_threats$simple_code %>%
  table() %>%
  as_data_frame() %>%
  plyr::rename(replace = c("." = "threat_code")) %>%
  arrange(-n)
```

